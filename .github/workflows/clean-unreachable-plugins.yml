name: Clean Unreachable Plugins

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 */3 * *'

jobs:
  clean-unreachable-plugins:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up jq and curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Clean unreachable plugins
        run: |
          set -euo pipefail
          echo "=== å¼€å§‹æ¸…ç†ä¸å¯è¾¾æ’ä»¶ ==="

          PLUGINS_JSON="plugins.json"
          UNREACHABLE_JSON="unreachable-plugins.json"
          TEMP_CURRENT_UNREACHABLE="temp_current.json"
          TEMP_PREV_UNREACHABLE="temp_prev.json"
          TEMP_PLUGINS="temp_plugins.json"

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å‡½æ•°
          cleanup() {
              rm -f "$TEMP_CURRENT_UNREACHABLE" "$TEMP_PREV_UNREACHABLE" "$TEMP_PLUGINS" "$TEMP_CURRENT_UNREACHABLE.tmp"
          }
          trap cleanup EXIT

          # åˆå§‹åŒ–å½“å‰ä¸å¯è¾¾åˆ—è¡¨
          echo "{}" > "$TEMP_CURRENT_UNREACHABLE"

          # è·å–ä¸»åˆ†æ”¯ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.json
          echo "è·å–ä¸»åˆ†æ”¯ä¸Šçš„ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.json..."
          if git show origin/main:"$UNREACHABLE_JSON" > "$TEMP_PREV_UNREACHABLE" 2>/dev/null; then
            echo "æˆåŠŸè·å–ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.json"
            PREV_UNREACHABLE_EXISTS=true
          else
            echo "æœªæ‰¾åˆ°ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.jsonï¼Œè§†ä¸ºé¦–æ¬¡è¿è¡Œ"
            PREV_UNREACHABLE_EXISTS=false
            echo "{}" > "$TEMP_PREV_UNREACHABLE"
          fi

          # æ£€æµ‹å½“å‰æ‰€æœ‰æ’ä»¶å¯è¾¾æ€§
          echo "æ£€æµ‹ plugins.json ä¸­æ‰€æœ‰æ’ä»¶çš„å¯è¾¾æ€§..."
          jq -r 'keys[]' "$PLUGINS_JSON" | while read -r plugin; do
            repo=$(jq -r ".[\"$plugin\"].repo" "$PLUGINS_JSON")
            echo "æ£€æŸ¥æ’ä»¶ $plugin çš„ä»“åº“: $repo"
            if curl --head --silent --fail --max-time 5 "$repo" >/dev/null; then
              echo "âœ“ $plugin å¯è¾¾"
            else
              echo "âœ— $plugin ä¸å¯è¾¾"
              jq --arg p "$plugin" '. + {($p): $repo}' "$TEMP_CURRENT_UNREACHABLE" > "$TEMP_CURRENT_UNREACHABLE.tmp" && mv "$TEMP_CURRENT_UNREACHABLE.tmp" "$TEMP_CURRENT_UNREACHABLE"
            fi
          done

          # å¤„ç†å·²çŸ¥ä¸å¯è¾¾æ’ä»¶ï¼ˆæ¥è‡ªä¸Šä¸€ç‰ˆæœ¬ï¼‰
          KNOWN_UNREACHABLE_PLUGINS=()
          if [ "$PREV_UNREACHABLE_EXISTS" = true ]; then
            mapfile -t KNOWN_UNREACHABLE_PLUGINS < <(jq -r 'keys[]' "$TEMP_PREV_UNREACHABLE")
          fi

          for plugin in "${KNOWN_UNREACHABLE_PLUGINS[@]}"; do
            if jq -e ".[\"$plugin\"]" "$TEMP_CURRENT_UNREACHABLE" >/dev/null; then
              echo "ğŸ” æ’ä»¶ $plugin ä»ä¸å¯è¾¾ï¼Œå°†ä» plugins.json ä¸­åˆ é™¤"
              jq "del(.\"$plugin\")" "$PLUGINS_JSON" > "$TEMP_PLUGINS" && mv "$TEMP_PLUGINS" "$PLUGINS_JSON"
            else
              echo "âœ… æ’ä»¶ $plugin å·²æ¢å¤å¯è¾¾ï¼Œä¿ç•™åœ¨ plugins.json ä¸­"
            fi
          done

          # ä¿å­˜æœ¬æ¬¡ä¸å¯è¾¾åˆ—è¡¨
          cp "$TEMP_CURRENT_UNREACHABLE" "$UNREACHABLE_JSON"

          # ç»Ÿè®¡ä¿¡æ¯
          CURRENT_COUNT=$(jq 'length' "$TEMP_CURRENT_UNREACHABLE")
          PREV_COUNT=$(jq 'length' "$TEMP_PREV_UNREACHABLE")
          echo "æœ¬æ¬¡å…±æ£€æµ‹åˆ° $CURRENT_COUNT ä¸ªä¸å¯è¾¾æ’ä»¶"
          echo "ä¸Šä¸€ç‰ˆæœ¬è®°å½•äº† $PREV_COUNT ä¸ªä¸å¯è¾¾æ’ä»¶"

      - name: Output the cleaned plugins.json
        run: |
          echo "Cleaned plugins.json:"
          cat plugins.json
          echo "Current unreachable-plugins.json:"
          cat unreachable-plugins.json

      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ $(git status --porcelain) ]]; then
            echo "Changes detected. Proceeding to commit and push."
            git add plugins.json unreachable-plugins.json
            git commit -m "Clean unreachable plugins and update unreachable-plugins.json"
            git push origin HEAD
          else
            echo "No changes detected. Skipping commit and push."
          fi
