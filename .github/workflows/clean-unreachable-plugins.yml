name: Clean Unreachable Plugins

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 */3 * *'

jobs:
  clean-unreachable-plugins:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up jq and curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Clean unreachable plugins
        run: |
          set -euo pipefail
          echo "=== å¼€å§‹æ¸…ç†ä¸å¯è¾¾æ’ä»¶ ==="

          PLUGINS_JSON="plugins.json"
          UNREACHABLE_JSON="unreachable-plugins.json"
          TEMP_CURRENT_UNREACHABLE="temp_current.json"
          TEMP_CURRENT_UNREACHABLE_TMP="temp_current.tmp.json"
          TEMP_PREV_UNREACHABLE="temp_prev.json"
          TEMP_PLUGINS="temp_plugins.json"
          TEMP_UPDATED_UNREACHABLE="temp_updated_unreachable.json"
          TEMP_DEL_PLUGINS="temp_del_plugins.json"

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å‡½æ•°
          cleanup() {
              rm -f \
                "$TEMP_CURRENT_UNREACHABLE" \
                "$TEMP_CURRENT_UNREACHABLE_TMP" \
                "$TEMP_PREV_UNREACHABLE" \
                "$TEMP_PLUGINS" \
                "$TEMP_UPDATED_UNREACHABLE" \
                "$TEMP_DEL_PLUGINS"
          }
          trap cleanup EXIT

          # åˆå§‹åŒ–å½“å‰ä¸å¯è¾¾åˆ—è¡¨
          echo "{}" > "$TEMP_CURRENT_UNREACHABLE"

          # è·å–ä¸»åˆ†æ”¯ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.json
          echo "è·å–ä¸»åˆ†æ”¯ä¸Šçš„ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.json..."
          if git show origin/main:"$UNREACHABLE_JSON" > "$TEMP_PREV_UNREACHABLE" 2>/dev/null; then
            echo "æˆåŠŸè·å–ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.json"
            PREV_UNREACHABLE_EXISTS=true
          else
            echo "æœªæ‰¾åˆ°ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.jsonï¼Œè§†ä¸ºé¦–æ¬¡è¿è¡Œ"
            PREV_UNREACHABLE_EXISTS=false
            echo "{}" > "$TEMP_PREV_UNREACHABLE"
          fi

          # æ£€æµ‹å½“å‰æ‰€æœ‰æ’ä»¶å¯è¾¾æ€§
          echo "æ£€æµ‹ plugins.json ä¸­æ‰€æœ‰æ’ä»¶çš„å¯è¾¾æ€§..."
          jq -r 'keys[]' "$PLUGINS_JSON" | while read -r plugin; do
            repo=$(jq -r --arg p "$plugin" '.[$p].repo' "$PLUGINS_JSON")
            echo "æ£€æŸ¥æ’ä»¶ $plugin çš„ä»“åº“: $repo"
            if curl --head --silent --fail --max-time 5 "$repo" >/dev/null; then
              echo "âœ“ $plugin å¯è¾¾"
            else
              echo "âœ— $plugin ä¸å¯è¾¾"
              jq --arg p "$plugin" --arg r "$repo" '. + {($p): $r}' "$TEMP_CURRENT_UNREACHABLE" > "$TEMP_CURRENT_UNREACHABLE_TMP" && mv "$TEMP_CURRENT_UNREACHABLE_TMP" "$TEMP_CURRENT_UNREACHABLE"
            fi
          done

          # ä¿å­˜æœ¬æ¬¡ä¸å¯è¾¾åˆ—è¡¨
          cp "$TEMP_CURRENT_UNREACHABLE" "$UNREACHABLE_JSON"

          # åˆå§‹åŒ–å·²åˆ é™¤æ’ä»¶è®°å½•æ–‡ä»¶
          DEL_PLUGINS="del-plugins.json"
          if [[ ! -f "$DEL_PLUGINS" ]]; then
            echo "{}" > "$DEL_PLUGINS"
          fi

          # è¯»å–ä¹‹å‰è®°å½•çš„ä¸å¯è¾¾æ’ä»¶
          PREV_UNREACHABLE_PLUGINS=()
          if [[ -s "$TEMP_PREV_UNREACHABLE" ]]; then
            mapfile -t PREV_UNREACHABLE_PLUGINS < <(jq -r 'keys[]' "$TEMP_PREV_UNREACHABLE")
          fi

          # å½“å‰ä»ä¸å¯è¾¾çš„æ’ä»¶
          mapfile -t CURRENT_UNREACHABLE_PLUGINS < <(jq -r 'keys[]' "$UNREACHABLE_JSON")

          # å…ˆå¤„ç†æ¢å¤å¯è¾¾çš„æƒ…å†µï¼šä» unreachable-plugins.json ä¸­ç§»é™¤å·²æ¢å¤çš„æ’ä»¶
          for plugin in "${PREV_UNREACHABLE_PLUGINS[@]}"; do
            if ! printf '%s\n' "${CURRENT_UNREACHABLE_PLUGINS[@]}" | grep -Fxq -- "$plugin"; then
              # è¿™é‡Œç›´æ¥å¤ç”¨æœ¬æ¬¡é¦–è½®æ£€æµ‹ç»“æœï¼šä¸åœ¨ CURRENT_UNREACHABLE_PLUGINS ä¸­å³è§†ä¸ºå·²æ¢å¤æˆ–å·²ç§»é™¤
              if jq -e --arg p "$plugin" 'has($p)' "$PLUGINS_JSON" >/dev/null; then
                echo "âœ… æ’ä»¶ $plugin å·²æ¢å¤å¯è¾¾ï¼Œä» unreachable-plugins.json ä¸­ç§»é™¤"
              else
                echo "â„¹ï¸ æ’ä»¶ $plugin å·²ä¸åœ¨ plugins.json ä¸­ï¼Œä» unreachable-plugins.json ä¸­ç§»é™¤"
              fi
              jq --arg p "$plugin" 'del(.[$p])' "$UNREACHABLE_JSON" > "$TEMP_UPDATED_UNREACHABLE" && mv "$TEMP_UPDATED_UNREACHABLE" "$UNREACHABLE_JSON"
            fi
          done

          # å¤„ç†è¿ç»­ä¸¤æ¬¡ä¸å¯è¾¾çš„æ’ä»¶
          for plugin in "${CURRENT_UNREACHABLE_PLUGINS[@]}"; do
            if printf '%s\n' "${PREV_UNREACHABLE_PLUGINS[@]}" | grep -Fxq -- "$plugin"; then
              # å…ˆä» plugins.json è·å–å®Œæ•´æ•°æ®ï¼ˆåˆ é™¤å‰ï¼‰
              plugin_data=$(jq --arg p "$plugin" '.[$p]' "$PLUGINS_JSON")
              if [ "$plugin_data" != "null" ]; then
                # è¿™é‡Œç›´æ¥å¤ç”¨æœ¬æ¬¡é¦–è½®æ£€æµ‹ç»“æœï¼ˆcurrent + prev äº¤é›†å³è¿ç»­ä¸¤æ¬¡ä¸å¯è¾¾ï¼‰
                echo "ğŸ” æ’ä»¶ $plugin è¿ç»­ä¸¤æ¬¡ä¸å¯è¾¾ï¼Œå°†ä» plugins.json å’Œ unreachable-plugins.json ä¸­åˆ é™¤"

                # å…ˆå†™å…¥ del-plugins.jsonï¼ˆåˆ é™¤å‰å†™å…¥ï¼Œç¡®ä¿æ•°æ®å®Œæ•´ï¼‰
                jq --arg p "$plugin" --argjson d "$plugin_data" '. + {($p): $d}' "$DEL_PLUGINS" > "$TEMP_DEL_PLUGINS" && mv "$TEMP_DEL_PLUGINS" "$DEL_PLUGINS"
                echo "âœ… å·²è®°å½•æ’ä»¶ $plugin åˆ° del-plugins.json"

                # ä» plugins.json åˆ é™¤
                jq --arg p "$plugin" 'del(.[$p])' "$PLUGINS_JSON" > "$TEMP_PLUGINS" && mv "$TEMP_PLUGINS" "$PLUGINS_JSON"

                # ä» unreachable-plugins.json åˆ é™¤ï¼ˆä½¿ç”¨ç‹¬ç«‹ä¸´æ—¶æ–‡ä»¶ï¼‰
                jq --arg p "$plugin" 'del(.[$p])' "$UNREACHABLE_JSON" > "$TEMP_UPDATED_UNREACHABLE" && mv "$TEMP_UPDATED_UNREACHABLE" "$UNREACHABLE_JSON"
              fi
            fi
          done

          # ç»Ÿè®¡ä¿¡æ¯
          CURRENT_COUNT=$(jq 'length' "$TEMP_CURRENT_UNREACHABLE")
          PREV_COUNT=$(jq 'length' "$TEMP_PREV_UNREACHABLE")
          echo "æœ¬æ¬¡å…±æ£€æµ‹åˆ° $CURRENT_COUNT ä¸ªä¸å¯è¾¾æ’ä»¶"
          echo "ä¸Šä¸€ç‰ˆæœ¬è®°å½•äº† $PREV_COUNT ä¸ªä¸å¯è¾¾æ’ä»¶"

      - name: Output the cleaned plugins.json
        run: |
          echo "Cleaned plugins.json:"
          cat plugins.json
          echo "Current unreachable-plugins.json:"
          cat unreachable-plugins.json

      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ $(git status --porcelain) ]]; then
            echo "Changes detected. Proceeding to commit and push."
            git add plugins.json unreachable-plugins.json del-plugins.json
            git commit -m "Clean unreachable plugins and update unreachable-plugins.json"
            git push origin HEAD
          else
            echo "No changes detected. Skipping commit and push."
          fi
