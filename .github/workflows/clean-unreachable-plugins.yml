name: Clean Unreachable Plugins

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 */3 * *'

jobs:
  clean-unreachable-plugins:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up jq and curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Clean unreachable plugins
        run: |
          set -euo pipefail
          echo "=== å¼€å§‹æ¸…ç†ä¸å¯è¾¾æ’ä»¶ ==="

          PLUGINS_JSON="plugins.json"
          UNREACHABLE_JSON="unreachable-plugins.json"
          TEMP_CURRENT_UNREACHABLE="temp_current.json"
          TEMP_PREV_UNREACHABLE="temp_prev.json"
          TEMP_PLUGINS="temp_plugins.json"

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å‡½æ•°
          cleanup() {
              rm -f "$TEMP_CURRENT_UNREACHABLE" "$TEMP_PREV_UNREACHABLE" "$TEMP_PLUGINS" "$TEMP_CURRENT_UNREACHABLE.tmp"
          }
          trap cleanup EXIT

          # åˆå§‹åŒ–å½“å‰ä¸å¯è¾¾åˆ—è¡¨
          echo "{}" > "$TEMP_CURRENT_UNREACHABLE"

          # è·å–ä¸»åˆ†æ”¯ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.json
          echo "è·å–ä¸»åˆ†æ”¯ä¸Šçš„ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.json..."
          if git show origin/main:"$UNREACHABLE_JSON" > "$TEMP_PREV_UNREACHABLE" 2>/dev/null; then
            echo "æˆåŠŸè·å–ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.json"
            PREV_UNREACHABLE_EXISTS=true
          else
            echo "æœªæ‰¾åˆ°ä¸Šä¸€ç‰ˆæœ¬ unreachable-plugins.jsonï¼Œè§†ä¸ºé¦–æ¬¡è¿è¡Œ"
            PREV_UNREACHABLE_EXISTS=false
            echo "{}" > "$TEMP_PREV_UNREACHABLE"
          fi

          # æ£€æµ‹å½“å‰æ‰€æœ‰æ’ä»¶å¯è¾¾æ€§
          echo "æ£€æµ‹ plugins.json ä¸­æ‰€æœ‰æ’ä»¶çš„å¯è¾¾æ€§..."
          jq -r 'keys[]' "$PLUGINS_JSON" | while read -r plugin; do
            repo=$(jq -r ".[\"$plugin\"].repo" "$PLUGINS_JSON")
            echo "æ£€æŸ¥æ’ä»¶ $plugin çš„ä»“åº“: $repo"
            if curl --head --silent --fail --max-time 5 "$repo" >/dev/null; then
              echo "âœ“ $plugin å¯è¾¾"
            else
              echo "âœ— $plugin ä¸å¯è¾¾"
              jq --arg p "$plugin" --arg r "$repo" '. + {($p): $r}' "$TEMP_CURRENT_UNREACHABLE" > "$TEMP_CURRENT_UNREACHABLE.tmp" && mv "$TEMP_CURRENT_UNREACHABLE.tmp" "$TEMP_CURRENT_UNREACHABLE"
            fi
          done

          # ä¿å­˜æœ¬æ¬¡ä¸å¯è¾¾åˆ—è¡¨
          cp "$TEMP_CURRENT_UNREACHABLE" "$UNREACHABLE_JSON"

          # åˆå§‹åŒ–å·²åˆ é™¤æ’ä»¶è®°å½•æ–‡ä»¶
          DEL_PLUGINS="del-plugins.json"
          if [[ ! -f "$DEL_PLUGINS" ]]; then
            echo "{}" > "$DEL_PLUGINS"
          fi

          # ç”¨äºå­˜å‚¨æ›´æ–°å unreachable åˆ—è¡¨çš„ä¸´æ—¶æ–‡ä»¶
          TEMP_UPDATED_UNREACHABLE="temp_updated_unreachable.json"

          # è¯»å–ä¹‹å‰è®°å½•çš„ä¸å¯è¾¾æ’ä»¶
          PREV_UNREACHABLE_PLUGINS=()
          if [[ -s "$TEMP_PREV_UNREACHABLE" ]]; then
            mapfile -t PREV_UNREACHABLE_PLUGINS < <(jq -r 'keys[]' "$TEMP_PREV_UNREACHABLE")
          fi

          # å½“å‰ä»ä¸å¯è¾¾çš„æ’ä»¶
          mapfile -t CURRENT_UNREACHABLE_PLUGINS < <(jq -r 'keys[]' "$UNREACHABLE_JSON")

          # å…ˆå¤„ç†æ¢å¤å¯è¾¾çš„æƒ…å†µï¼šä» unreachable-plugins.json ä¸­ç§»é™¤å·²æ¢å¤çš„æ’ä»¶
          for plugin in "${PREV_UNREACHABLE_PLUGINS[@]}"; do
            if ! printf '%s\n' "${CURRENT_UNREACHABLE_PLUGINS[@]}" | grep -q "^$plugin$"; then
              # æ’ä»¶æ›¾ä¸å¯è¾¾ä½†å½“å‰å¯è¾¾äº†
              repo=$(jq -r ".[\"$plugin\"].repo" "$PLUGINS_JSON")
              if curl --head --silent --fail --max-time 5 "$repo" >/dev/null; then
                echo "âœ… æ’ä»¶ $plugin å·²æ¢å¤å¯è¾¾ï¼Œä» unreachable-plugins.json ä¸­ç§»é™¤"
                jq "del(.\"$plugin\")" "$UNREACHABLE_JSON" > "$TEMP_UPDATED_UNREACHABLE" && mv "$TEMP_UPDATED_UNREACHABLE" "$UNREACHABLE_JSON"
              fi
            fi
          done

          # å¤„ç†è¿ç»­ä¸¤æ¬¡ä¸å¯è¾¾çš„æ’ä»¶
          for plugin in "${CURRENT_UNREACHABLE_PLUGINS[@]}"; do
            if printf '%s\n' "${PREV_UNREACHABLE_PLUGINS[@]}" | grep -q "^$plugin$"; then
              repo=$(jq -r ".[\"$plugin\"].repo" "$PLUGINS_JSON")
              if ! curl --head --silent --fail --max-time 5 "$repo" >/dev/null; then
                echo "ğŸ” æ’ä»¶ $plugin è¿ç»­ä¸¤æ¬¡ä¸å¯è¾¾ï¼Œå°†ä» plugins.json å’Œ unreachable-plugins.json ä¸­åˆ é™¤"

                # ä» plugins.json åˆ é™¤
                jq "del(.\"$plugin\")" "$PLUGINS_JSON" > "$TEMP_PLUGINS" && mv "$TEMP_PLUGINS" "$PLUGINS_JSON"

                # ä» unreachable-plugins.json åˆ é™¤ï¼ˆä½¿ç”¨ç‹¬ç«‹ä¸´æ—¶æ–‡ä»¶ï¼‰
                jq "del(.\"$plugin\")" "$UNREACHABLE_JSON" > "$TEMP_UPDATED_UNREACHABLE" && mv "$TEMP_UPDATED_UNREACHABLE" "$UNREACHABLE_JSON"

                # å†™å…¥ del-plugins.jsonï¼Œä½¿ç”¨ç‹¬ç«‹ä¸´æ—¶æ–‡ä»¶é¿å…å†²çª
                TEMP_DEL_PLUGINS="temp_del_plugins.json"
                jq --arg p "$plugin" --arg r "$repo" '. + {($p): $r}' "$DEL_PLUGINS" > "$TEMP_DEL_PLUGINS" && mv "$TEMP_DEL_PLUGINS" "$DEL_PLUGINS"
              fi
            fi
          done

          # ç»Ÿè®¡ä¿¡æ¯
          CURRENT_COUNT=$(jq 'length' "$TEMP_CURRENT_UNREACHABLE")
          PREV_COUNT=$(jq 'length' "$TEMP_PREV_UNREACHABLE")
          echo "æœ¬æ¬¡å…±æ£€æµ‹åˆ° $CURRENT_COUNT ä¸ªä¸å¯è¾¾æ’ä»¶"
          echo "ä¸Šä¸€ç‰ˆæœ¬è®°å½•äº† $PREV_COUNT ä¸ªä¸å¯è¾¾æ’ä»¶"

      - name: Output the cleaned plugins.json
        run: |
          echo "Cleaned plugins.json:"
          cat plugins.json
          echo "Current unreachable-plugins.json:"
          cat unreachable-plugins.json

      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ $(git status --porcelain) ]]; then
            echo "Changes detected. Proceeding to commit and push."
            git add plugins.json unreachable-plugins.json del-plugins.json
            git commit -m "Clean unreachable plugins and update unreachable-plugins.json"
            git push origin HEAD
          else
            echo "No changes detected. Skipping commit and push."
          fi
